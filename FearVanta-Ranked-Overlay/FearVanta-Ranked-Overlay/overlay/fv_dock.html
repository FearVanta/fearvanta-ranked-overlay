<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PROJECT OBSIDIAN Control Dock</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0a0a0f;
            --surface: #111118;
            --border: rgba(255,255,255,0.07);
            --accent: #4fd3ff;
            --accent2: #b44cff;
            --text: #e8e8f0;
            --muted: rgba(255,255,255,0.35);
            --success: #00ffaa;
            --danger: #ff3b3b;
        }

        :root.light {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --border: rgba(0,0,0,0.1);
            --accent: #0099cc;
            --accent2: #7c3aed;
            --text: #1a1a2e;
            --muted: rgba(0,0,0,0.4);
            --success: #00aa66;
            --danger: #cc2200;
        }

        :root.light select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(0,0,0,0.4)'/%3E%3C/svg%3E");
        }

        :root.light #dockLogo {
            filter: invert(1);
        }

        :root.light input:disabled, :root.light select:disabled {
            opacity: 0.25;
        }

        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }

        .theme-toggle:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        /* Top 250 placement badge in preview */
        .preview-placement {
            display: none;
            align-items: center;
            gap: 4px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            color: #ffffff;
            background: linear-gradient(135deg, #b44cff, #4fd3ff);
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 6px;
        }

        .preview-placement.show {
            display: flex;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            min-height: 100vh;
            padding: 12px;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .version {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: var(--muted);
        }

        /* Status indicator */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-family: 'Share Tech Mono', monospace;
            color: var(--muted);
            margin-bottom: 14px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted);
            transition: background 0.3s;
        }

        .status-dot.ok { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .status-dot.err { background: var(--danger); box-shadow: 0 0 6px var(--danger); }

        /* Rank preview */
        .rank-preview {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-rank {
            font-size: 20px;
            font-weight: 700;
            transition: color 0.3s;
        }

        .preview-sr {
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            color: var(--muted);
            margin-left: auto;
        }

        .preview-tier {
            font-size: 11px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Form fields */
        .field {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 7px 10px;
            outline: none;
            transition: border-color 0.2s;
            appearance: none;
        }

        input:disabled, select:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255,255,255,0.04);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--accent);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.3)'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
            cursor: pointer;
        }

        select option {
            background: #111118;
        }

        /* Opacity slider */
        .slider-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent);
            cursor: pointer;
        }

        .slider-value {
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: var(--accent);
            width: 34px;
            text-align: right;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 14px 0;
        }

        /* Buttons */
        .btn-update {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            color: #000;
            font-family: 'Rajdhani', sans-serif;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            text-transform: uppercase;
        }

        .btn-update:hover { opacity: 0.85; }
        .btn-update:active { transform: scale(0.98); }
        .btn-update:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%) translateY(40px);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--danger); color: var(--danger); }

        /* SR progress bar */
        .sr-progress {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .sr-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.4s ease, background 0.4s ease;
        }
    </style>
</head>
<body>

    <div class="header">
        <img id="dockLogo" src="assets/icons/ProjectObsidian.png" style="height:28px;width:auto;object-fit:contain;transition:filter 0.2s;" alt="ObsidianHUD" />
        <div style="display:flex;align-items:center;gap:8px;">
            <div class="version">PROJECT OBSIDIAN v1.0</div>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">â˜€ LIGHT</button>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Live rank preview -->
    <div class="rank-preview">
        <div>
            <div class="preview-rank" id="previewRank">Bronze I</div>
            <div class="preview-tier" id="previewTier">TIER 1</div>
        </div>
        <div class="sr-progress" style="flex:1; margin:0 10px; align-self:center;">
            <div class="sr-progress-fill" id="progressFill"></div>
        </div>
        <span class="preview-placement" id="previewPlacement">ðŸ‘‘ #0</span>
        <div class="preview-sr" id="previewSR">SR: 0</div>
    </div>

    <!-- Username -->
    <div class="field">
        <label>Activision Username</label>
        <input type="text" id="username" placeholder="@fearvanta#000000" />
    </div>

    <!-- SR -->
    <div class="field">
        <label>SR</label>
        <input type="number" id="sr" min="0" max="15000" placeholder="0" />
        <div class="sr-progress" style="margin-top:6px;">
            <div class="sr-progress-fill" id="inputProgressFill"></div>
        </div>
    </div>

    <!-- Top 250 Position -->
    <div class="field">
        <label>Top 250 Position <span style="opacity:0.4;font-size:10px;text-transform:none;">(0 = not on leaderboard)</span></label>
        <input type="number" id="leaderboard_pos" min="0" max="250" placeholder="0" value="0" />
    </div>

    <!-- Background -->
    <div class="field">
        <label>Background Template</label>
        <select id="background">
            <option value="classic-dark">Classic Dark</option>
            <option value="dark-glass">Dark Glass</option>
            <option value="neon-grid">Neon Grid</option>
            <option value="cyber-wave">Cyber Wave</option>
            <option value="matrix">Matrix</option>
            <option value="aurora">Aurora</option>
            <option value="crimson-flame">Crimson Flame</option>
            <option value="frozen-ice">Frozen Ice</option>
            <option value="marble-white">Marble White</option>
        </select>
    </div>

    <!-- Layout -->
    <div class="field">
        <label>Layout</label>
        <select id="layout">
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
        </select>
    </div>

    <!-- Opacity -->
    <div class="field">
        <label>Background Opacity</label>
        <div class="slider-wrap">
            <input type="range" id="opacity" min="0" max="1" step="0.01" value="0.85" />
            <div class="slider-value" id="opacityVal">0.85</div>
        </div>
    </div>

    <div class="divider"></div>

    <button class="btn-update" id="updateBtn" onclick="saveOverlay()">â¬† UPDATE OVERLAY</button>

    <div class="toast" id="toast"></div>

    <script>
        const tiers = [
            { min: 0,     max: 300,   name: "Bronze I",     color: "#b87333" },
            { min: 300,   max: 600,   name: "Bronze II",    color: "#b87333" },
            { min: 600,   max: 900,   name: "Bronze III",   color: "#b87333" },
            { min: 900,   max: 1300,  name: "Silver I",     color: "#c0c0c0" },
            { min: 1300,  max: 1700,  name: "Silver II",    color: "#c0c0c0" },
            { min: 1700,  max: 2100,  name: "Silver III",   color: "#c0c0c0" },
            { min: 2100,  max: 2600,  name: "Gold I",       color: "#ffd700" },
            { min: 2600,  max: 3100,  name: "Gold II",      color: "#ffd700" },
            { min: 3100,  max: 3600,  name: "Gold III",     color: "#ffd700" },
            { min: 3600,  max: 4200,  name: "Platinum I",   color: "#4fd3ff" },
            { min: 4200,  max: 4800,  name: "Platinum II",  color: "#4fd3ff" },
            { min: 4800,  max: 5400,  name: "Platinum III", color: "#4fd3ff" },
            { min: 5400,  max: 6100,  name: "Diamond I",    color: "#4a90ff" },
            { min: 6100,  max: 6800,  name: "Diamond II",   color: "#4a90ff" },
            { min: 6800,  max: 7500,  name: "Diamond III",  color: "#4a90ff" },
            { min: 7500,  max: 8300,  name: "Crimson I",    color: "#ff3b3b" },
            { min: 8300,  max: 9100,  name: "Crimson II",   color: "#ff3b3b" },
            { min: 9100,  max: 10000, name: "Crimson III",  color: "#ff3b3b" },
            { min: 10000, max: 13000, name: "Iridescent",   color: "#b44cff" },
            { min: 13000, max: 15000, name: "Top 250",      color: "#ffffff" }
        ];

        function getTier(sr) {
            return tiers.find(t => sr >= t.min && sr < t.max) || tiers[0];
        }

        function updatePreview(sr, pos) {
            const position = (pos != null) ? pos : (parseInt(document.getElementById("leaderboard_pos").value) || 0);
            const isTop250 = sr >= 10000 && position >= 1 && position <= 250;
            const tier = isTop250
                ? { name: "Top 250", color: "#ffffff", min: 10000, max: 99999 }
                : getTier(sr);

            document.getElementById("previewRank").textContent = tier.name;
            document.getElementById("previewRank").style.color = tier.color;
            document.getElementById("previewSR").textContent = "SR: " + sr;
            document.getElementById("previewTier").textContent = "TIER " + (tiers.indexOf(getTier(sr)) + 1) + " OF " + tiers.length;

            const pct = ((sr - getTier(sr).min) / (getTier(sr).max - getTier(sr).min)) * 100;
            document.getElementById("progressFill").style.width = pct + "%";
            document.getElementById("progressFill").style.background = tier.color;
            document.getElementById("inputProgressFill").style.width = pct + "%";
            document.getElementById("inputProgressFill").style.background = tier.color;

            // Show/hide placement badge
            const badge = document.getElementById("previewPlacement");
            if (isTop250) {
                badge.textContent = "ðŸ‘‘ #" + position;
                badge.classList.add("show");
            } else {
                badge.classList.remove("show");
            }
        }

        // Opacity slider live update
        document.getElementById("opacity").addEventListener("input", function() {
            document.getElementById("opacityVal").textContent = parseFloat(this.value).toFixed(2);
        });

        // SR live preview + Top 250 lock
        document.getElementById("sr").addEventListener("input", function() {
            const sr = parseInt(this.value) || 0;
            updatePreview(sr);
            const posField = document.getElementById("leaderboard_pos");
            if (sr >= 10000) {
                posField.disabled = false;
            } else {
                posField.disabled = true;
                posField.value = 0;
            }
        });

        let userTyping = false;
        let typingTimer = null;

        document.getElementById("leaderboard_pos").addEventListener("input", function() {
            updatePreview(parseInt(document.getElementById("sr").value) || 0, parseInt(this.value) || 0);
        });

        ["username", "sr", "opacity", "background", "layout", "leaderboard_pos"].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener("focus", () => { userTyping = true; clearTimeout(typingTimer); });
            el.addEventListener("blur", () => { typingTimer = setTimeout(() => { userTyping = false; }, 3000); });
        });

        // Load current overlay.json on startup â€” skips if user is actively editing
        async function loadCurrent() {
            if (userTyping) { setStatus(true); return; }
            try {
                const res = await fetch("config/overlay.json?cache=" + Date.now());
                const data = await res.json();
                document.getElementById("username").value = data.username ?? "";
                document.getElementById("sr").value = data.sr ?? 0;
                document.getElementById("opacity").value = data.opacity ?? 0.85;
                document.getElementById("opacityVal").textContent = parseFloat(data.opacity ?? 0.85).toFixed(2);
                document.getElementById("background").value = data.background ?? "classic-dark";
                document.getElementById("layout").value = data.layout ?? "horizontal";
                const pos = data.leaderboard_pos ?? 0;
                document.getElementById("leaderboard_pos").value = pos;
                document.getElementById("leaderboard_pos").disabled = (data.sr ?? 0) < 10000;
                updatePreview(data.sr ?? 0);
                setStatus(true);
            } catch(e) {
                setStatus(false);
            }
        }

        function setStatus(ok) {
            document.getElementById("statusDot").className = "status-dot " + (ok ? "ok" : "err");
            document.getElementById("statusText").textContent = ok ? "Overlay connected" : "Cannot reach overlay.json";
        }

        async function saveOverlay() {
            const btn = document.getElementById("updateBtn");
            btn.disabled = true;

            const payload = {
                sr: parseInt(document.getElementById("sr").value) || 0,
                username: document.getElementById("username").value || "@USERNAME",
                opacity: parseFloat(document.getElementById("opacity").value),
                background: document.getElementById("background").value,
                layout: document.getElementById("layout").value,
                leaderboard_pos: parseInt(document.getElementById("leaderboard_pos").value) || 0
            };

            try {
                const res = await fetch("/save", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload, null, 4)
                });

                if (res.ok) {
                    showToast("âœ“ Overlay updated!", "success");
                    updatePreview(payload.sr);
                    setStatus(true);
                } else {
                    throw new Error("Server error");
                }
            } catch(e) {
                showToast("âš  Could not save â€” is server.js running?", "error");
            }

            btn.disabled = false;
        }

        function showToast(msg, type) {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.className = "toast " + type + " show";
            setTimeout(() => t.className = "toast " + type, 2500);
        }

        loadCurrent();
        setInterval(loadCurrent, 5000);

        // Poll for update notifications every 10 seconds
        async function checkUpdateStatus() {
            try {
                const res = await fetch("/update-status");
                const data = await res.json();
                if (data.available && data.version) {
                    showUpdateToast(data.version);
                    // Mark as seen so it doesn't keep showing
                    await fetch("/update-seen", { method: "POST" });
                }
            } catch(e) {}
        }

        function showUpdateToast(version) {
            const t = document.getElementById("toast");
            t.innerHTML = `â¬† Updated to v${version} â€” refresh OBS to apply!`;
            t.className = "toast success show";
            t.style.cursor = "pointer";
            t.onclick = () => { t.className = "toast success"; t.style.cursor = ""; };
            // Keep visible for 10 seconds since it's important
            setTimeout(() => { t.className = "toast success"; }, 10000);
        }

        setInterval(checkUpdateStatus, 10000);
        checkUpdateStatus();

        // Theme toggle â€” saved via server so it persists across refreshes
        async function toggleTheme() {
            const isLight = document.documentElement.classList.toggle("light");
            document.getElementById("themeToggle").textContent = isLight ? "ðŸŒ™ DARK" : "â˜€ LIGHT";
            try {
                await fetch("/save-theme", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ theme: isLight ? "light" : "dark" })
                });
            } catch(e) {}
        }

        // Load saved theme from server
        async function loadTheme() {
            try {
                const res = await fetch("/theme");
                const data = await res.json();
                if (data.theme === "light") {
                    document.documentElement.classList.add("light");
                    document.getElementById("themeToggle").textContent = "ðŸŒ™ DARK";
                }
            } catch(e) {}
        }

        loadTheme();
    </script>
</body>
</html>
